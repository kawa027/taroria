<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Taroria · 今日运势</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Noto+Serif+SC:wght@400;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-1: #060a1b;
      --bg-2: #121c3e;
      --panel: rgba(10, 16, 43, 0.56);
      --line: rgba(248, 215, 130, 0.36);
      --gold: #f7d58a;
      --text: #f5efe2;
      --shadow: rgba(0, 0, 0, 0.44);
          }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      color: var(--text);
      font-family: "Cinzel Decorative", "Noto Serif SC", "Noto Serif TC", "PingFang SC", "Microsoft YaHei", serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background:
        radial-gradient(circle at 16% 18%, rgba(255, 221, 148, 0.2), transparent 36%),
        radial-gradient(circle at 86% 84%, rgba(94, 129, 255, 0.22), transparent 38%),
        linear-gradient(160deg, var(--bg-1), var(--bg-2));
      overflow-x: hidden;
      overflow-y: auto;
      padding: 16px 0 28px;
    }

    body::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background-image:
        radial-gradient(2px 2px at 23% 28%, rgba(255, 255, 255, 0.8), transparent),
        radial-gradient(1.6px 1.6px at 56% 22%, rgba(255, 255, 255, 0.68), transparent),
        radial-gradient(1.8px 1.8px at 74% 60%, rgba(255, 255, 255, 0.76), transparent),
        radial-gradient(1.6px 1.6px at 34% 74%, rgba(255, 255, 255, 0.78), transparent);
      opacity: 0.84;
      animation: twinkle 6s ease-in-out infinite alternate;
    }

    @keyframes twinkle {
      from { transform: translateY(0); opacity: 0.74; }
      to { transform: translateY(-5px); opacity: 1; }
    }

    .back {
      position: fixed;
      top: 18px;
      left: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(8, 13, 33, 0.55);
      border: 1px solid rgba(248, 215, 130, 0.38);
      backdrop-filter: blur(4px);
      color: rgba(245, 239, 226, 0.9);
      text-decoration: none;
      z-index: 3;
    }

    .site-logo {
      position: fixed;
      top: 22px;
      left: 72px;
      z-index: 4;
      display: inline-block;
      pointer-events: none;
      width: max-content;
      font-family: "Cinzel Decorative", "Noto Serif SC", "Noto Serif TC", serif;
      font-size: clamp(1.1rem, 2.5vw, 1.55rem);
      letter-spacing: 0.14em;
      color: transparent;
      background: linear-gradient(180deg, #ffeab5 0%, #f7d58a 45%, #c68f2b 100%);
      -webkit-background-clip: text;
      background-clip: text;
      text-shadow: 0 0 10px rgba(248, 215, 130, 0.32);
    }

    .back:hover { color: #fff4d5; }

    .back-icon {
      width: 22px;
      height: 22px;
      transform: rotate(180deg);
      filter: drop-shadow(0 0 4px rgba(247, 213, 138, 0.35));
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
      white-space: nowrap;
    }

    .layout {
      position: relative;
      z-index: 1;
      width: min(94vw, 980px);
      border-radius: 28px;
      padding: 36px 20px 30px;
      background: var(--panel);
      box-shadow: 0 26px 52px var(--shadow), inset 0 0 0 1px var(--line);
      backdrop-filter: blur(6px);
      margin: auto 0;
    }

    .title {
      margin: 0;
      text-align: center;
      font-family: "Cinzel Decorative", "Noto Serif SC", "Noto Serif TC", "PingFang SC", "Microsoft YaHei", serif;
      font-size: clamp(2rem, 5.2vw, 3.2rem);
      letter-spacing: 0.08em;
      color: var(--gold);
      text-shadow: 0 0 14px rgba(247, 213, 138, 0.33);
    }

    .hint {
      margin: 12px 0 28px;
      text-align: center;
      color: rgba(245, 239, 226, 0.9);
      font-size: clamp(1rem, 2.2vw, 1.12rem);
      letter-spacing: 0.04em;
    }

    .content {
      display: grid;
      grid-template-columns: minmax(220px, 280px) 1fr;
      gap: 20px;
      align-items: stretch;
    }

    .card-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
    }

    .img-en-name {
      margin: -4px 0 0;
      font-size: 0.9rem;
      color: rgba(245, 239, 226, 0.82);
      letter-spacing: 0.03em;
      min-height: 1.2em;
      text-align: center;
    }

    .tarot-card {
      width: min(74vw, 240px);
      aspect-ratio: 3 / 5;
      border: 0;
      border-radius: 18px;
      cursor: pointer;
      padding: 0;
      position: relative;
      perspective: 1000px;
      background: transparent;
      opacity: 0;
      transform: translateY(18px) scale(0.9);
      pointer-events: none;
      transition: opacity 320ms ease, transform 460ms cubic-bezier(0.2, 0.8, 0.22, 1);
    }

    .tarot-card.is-dealt {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
    }

    .tarot-card.is-dealt:hover {
      transform: translateY(-4px);
    }

    .tarot-card:disabled {
      cursor: wait;
    }

    .card-inner {
      display: block;
      position: relative;
      width: 100%;
      height: 100%;
      -webkit-transform-style: preserve-3d;
      transform-style: preserve-3d;
      transition: transform 780ms cubic-bezier(0.2, 0.8, 0.22, 1);
    }

    .tarot-card.is-flipped .card-inner {
      transform: rotateY(180deg);
    }

    .card-side {
      display: block;
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 18px;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      color: #f8f0db;
      box-shadow: 0 14px 28px rgba(0, 0, 0, 0.4), inset 0 0 0 2px rgba(248, 215, 130, 0.46);
      overflow: hidden;
    }

    .card-side img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .card-side::before {
      content: "";
      position: absolute;
      inset: 12px;
      border-radius: 12px;
      border: 1px solid rgba(248, 215, 130, 0.5);
    }

    .card-back {
      background: #0f173d;
    }

    .card-front {
      transform: rotateY(180deg);
      background: #111a45;
    }

    .card-front img.is-reversed {
      transform: rotate(180deg);
    }

    .draw-btn {
      border: 0;
      cursor: pointer;
      border-radius: 999px;
      padding: 12px 24px;
      font-family: "Cinzel Decorative", "Noto Serif SC", "Noto Serif TC", "PingFang SC", "Microsoft YaHei", serif;
      font-size: 1rem;
      font-weight: 700;
      color: #2d1b00;
      background: linear-gradient(140deg, #ffe5a7, #f0bf58);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.32);
    }

    .draw-btn:hover { filter: brightness(1.03); }

    .panel {
      border-radius: 18px;
      padding: 20px 20px 18px;
      background: rgba(8, 13, 34, 0.52);
      border: 1px solid rgba(248, 215, 130, 0.25);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .panel h2 {
      margin: 0;
      color: var(--gold);
      font-size: clamp(1.3rem, 3.6vw, 1.8rem);
      letter-spacing: 0.05em;
    }

    .en-name {
      margin: -4px 0 2px;
      color: rgba(245, 239, 226, 0.82);
      font-size: 0.95rem;
      letter-spacing: 0.03em;
    }

    .tag {
      display: inline-flex;
      width: fit-content;
      font-size: 0.9rem;
      color: #ffd88f;
      border-radius: 999px;
      padding: 5px 10px;
      background: rgba(255, 217, 143, 0.12);
      border: 1px solid rgba(255, 217, 143, 0.3);
    }

    .meaning {
      margin: 0;
      line-height: 1.75;
      color: rgba(245, 239, 226, 0.95);
      font-size: 1rem;
    }

    .tip {
      margin: 0;
      color: rgba(245, 239, 226, 0.8);
      font-size: 0.95rem;
    }

    .deep-wrap {
      margin-top: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .deep-btn {
      border: 0;
      cursor: pointer;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(8, 13, 33, 0.55);
      border: 1px solid rgba(248, 215, 130, 0.38);
      backdrop-filter: blur(4px);
      color: rgba(245, 239, 226, 0.9);
      box-shadow: none;
    }

    .deep-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .deep-panel {
      display: none;
      margin-top: 24px;
      border-radius: 14px;
      padding: 14px;
      background: rgba(9, 14, 35, 0.72);
      border: 1px solid rgba(248, 215, 130, 0.25);
      width: 100%;
    }

    .deep-panel.open {
      display: block;
    }

    .arrow-icon {
      width: 22px;
      height: 22px;
      transition: transform 220ms ease;
      filter: drop-shadow(0 0 4px rgba(247, 213, 138, 0.35));
      transform: rotate(90deg);
    }

    .deep-btn.open .arrow-icon {
      transform: rotate(-90deg);
    }

    .deep-title {
      margin: 0 0 8px;
      color: var(--gold);
      font-size: 1.05rem;
    }

    .deep-text {
      margin: 0;
      white-space: pre-wrap;
      line-height: 1.8;
      color: rgba(245, 239, 226, 0.93);
      font-size: 0.97rem;
    }

    .loading-block {
      display: none;
      margin: 2px 0 6px;
    }

    .loading-label {
      margin: 0;
      font-size: 0.92rem;
      color: rgba(245, 239, 226, 0.86);
      letter-spacing: 0.03em;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .loading-dots {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transform: translateY(1px);
    }

    .loading-dots .dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--gold);
      opacity: 0.16;
      animation: dots-mystic 1.9s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }

    .loading-dots .dot:nth-child(2) { animation-delay: 0.28s; }
    .loading-dots .dot:nth-child(3) { animation-delay: 0.56s; }

    @keyframes dots-mystic {
      0%, 24%, 100% { opacity: 0.16; transform: scale(0.8); }
      36%, 56% { opacity: 0.9; transform: scale(1.08); }
    }

    .deep-panel.is-loading .loading-block {
      display: block;
    }

    .deep-panel.is-loading .deep-text {
      display: none;
    }

    @media (max-width: 820px) {
      .content {
        grid-template-columns: 1fr;
      }

      .card-wrap {
        margin-bottom: 6px;
      }

      .tarot-card {
        width: min(62vw, 260px);
      }

      .site-logo {
        left: 70px;
        top: 24px;
        font-size: 1.05rem;
      }
    }
  </style>
</head>
<body>
  <div class="site-logo" aria-hidden="true">Taroria</div>
  <a class="back" href="./draw.html" aria-label="返回抽牌方式页">
    <svg class="back-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M5 12H19" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" />
      <path d="M13 6L19 12L13 18" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" />
    </svg>
    <span class="sr-only">返回抽牌方式页</span>
  </a>

  <main class="layout">
    <h1 class="title">今日运势</h1>
    <p class="hint">先点击“抽取今日牌”发牌背，再点击牌背翻开今日指引</p>

    <section class="content">
      <div class="card-wrap">
        <button class="tarot-card" id="cardBtn" aria-label="点击抽取今日塔罗牌">
          <span class="card-inner">
            <span class="card-side card-back"><img id="cardBackImg" alt="塔罗牌背" /></span>
            <span class="card-side card-front"><img id="cardFrontImg" alt="塔罗牌面" /></span>
          </span>
        </button>
        <p class="img-en-name" id="cardImgEnglishName">Waiting</p>
        <button class="draw-btn" id="drawBtn">抽取今日牌</button>
      </div>

      <article class="panel" aria-live="polite">
        <h2 id="cardName">等待抽牌</h2>
        <p class="en-name" id="cardEnglishName">Waiting to reveal</p>
        <span class="tag" id="cardDirection">今日提示</span>
        <p class="meaning" id="cardMeaning">你的能量还在汇聚。准备好后抽一张牌，查看今天的重点讯息。</p>
        <p class="tip">每日建议只抽一张，给自己一个清晰而稳定的行动方向。</p>
      </article>
    </section>

    <section class="deep-wrap" aria-live="polite">
      <button class="deep-btn" id="deepDailyBtn" disabled aria-label="展开深度解读">
        <svg class="arrow-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M5 12H19" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" />
          <path d="M13 6L19 12L13 18" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        <span class="sr-only">深度解读</span>
      </button>
      <article class="deep-panel" id="deepDailyPanel">
        <h3 class="deep-title">今日牌深度解读</h3>
        <div class="loading-block" id="deepDailyLoading">
          <p class="loading-label" id="deepDailyLoadingLabel">正在读取秘密脉络 <span class="loading-dots" aria-hidden="true"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></p>
        </div>
        <p class="deep-text" id="deepDailyText">翻开牌后，你可以在这里查看更完整的解读。</p>
      </article>
    </section>
  </main>

  <script src="./tarot-deck.js"></script>
  <script>

    const cardNameEl = document.getElementById('cardName');
    const cardEnglishNameEl = document.getElementById('cardEnglishName');
    const cardDirectionEl = document.getElementById('cardDirection');
    const cardMeaningEl = document.getElementById('cardMeaning');
    const cardBtnEl = document.getElementById('cardBtn');
    const drawBtnEl = document.getElementById('drawBtn');
    const cardBackImgEl = document.getElementById('cardBackImg');
    const cardFrontImgEl = document.getElementById('cardFrontImg');
    const cardImgEnglishNameEl = document.getElementById('cardImgEnglishName');
    const deepDailyBtnEl = document.getElementById('deepDailyBtn');
    const deepDailyPanelEl = document.getElementById('deepDailyPanel');
    const deepDailyTextEl = document.getElementById('deepDailyText');
    const deepDailyLoadingLabelEl = document.getElementById('deepDailyLoadingLabel');
    let pendingCard = null;
    let hasFlipped = false;
    let dailyReadingRequestId = 0;
    let dailyProgressController = null;
    let dailyReadingCacheKey = '';
    let dailyReadingCacheText = '';
    cardBackImgEl.src = window.TAROT.cardBackImage;

    function buildDailyDeepReading(card) {
      const isMajor = card.arcana === '大阿尔卡那';
      const suitToneMap = {
        '圣杯': '情感与关系',
        '星币': '现实与资源',
        '宝剑': '思维与决断',
        '权杖': '行动与推进'
      };
      const suitTone = suitToneMap[card.suit] || '核心课题';
      const directionTone = card.reversed
        ? '今天比较适合先修正、先收敛，不急着扩张。'
        : '今天适合顺势推进，主动做出一个明确动作。';
      const baseHint = String(card.meaning).replace(/^正位提示：|^逆位提示：/, '');

      const emotionalLine = card.reversed
        ? `「${card.name}」逆位在情感上提醒你：先处理内在不安，再谈关系里的对错。`
        : `「${card.name}」正位在情感上给你的讯号是：真诚表达会带来关系修复与靠近。`;

      const workLine = isMajor
        ? `工作面上，这张大阿尔卡那更像“主题牌”，表示你今天的关键任务是：围绕「${card.name}」的能量完成一个核心决策。`
        : `工作面上，你抽到的是「${card.suit}」系统，主轴在${suitTone}。今天请优先处理「${card.focus}」这件事。`;

      const moneyLine = card.suit === '星币'
        ? (card.reversed
            ? '金钱面要先补漏洞：暂缓高风险投入，先把既有开支与现金流校正。'
            : '金钱面偏稳定：适合做务实规划、分配预算，并推进可落地的财务安排。')
        : (card.reversed
            ? '金钱面建议保守：先观察、先盘点，再做额外承诺。'
            : '金钱面可小步前进：以稳定增量为主，不必一次压重注。');

      const luckLine = card.reversed
        ? '整体运势属于「可调整型」，你越愿意放慢一步，后面的路越清楚。'
        : '整体运势属于「可放大型」，你越果断聚焦，正向回馈越快出现。';

      return `你今天抽到的是「${card.name}（${card.englishName}）」${card.direction}。\n` +
        `核心提示：${baseHint}。${directionTone}\n\n` +
        `情感：\n${emotionalLine}\n\n` +
        `工作：\n${workLine}\n\n` +
        `金钱：\n${moneyLine}\n\n` +
        `运势：\n${luckLine}\n\n` +
        `一句今日行动：\n` +
        `「以${card.name}为主轴，先把最关键的一步走稳。」`;
    }

    function dealDailyCard() {
      pendingCard = window.TAROT.draw(1)[0];
      hasFlipped = false;
      cardBtnEl.classList.remove('is-dealt', 'is-flipped');
      void cardBtnEl.offsetWidth;
      cardBtnEl.classList.add('is-dealt');
      cardFrontImgEl.removeAttribute('src');
      cardFrontImgEl.classList.remove('is-reversed');
      cardImgEnglishNameEl.textContent = 'Waiting';
      cardNameEl.textContent = '等待翻牌';
      cardEnglishNameEl.textContent = 'Waiting to reveal';
      cardDirectionEl.textContent = '今日提示';
      cardMeaningEl.textContent = '牌已抽出。点击左侧牌背，翻开你今天的讯息。';
      deepDailyBtnEl.disabled = true;
      deepDailyBtnEl.classList.remove('open');
      deepDailyPanelEl.classList.remove('open');
      deepDailyTextEl.textContent = '翻开牌后，你可以在这里查看更完整的解读。';
      dailyReadingCacheKey = '';
      dailyReadingCacheText = '';
    }

    function flipDailyCard() {
      if (!pendingCard) return;
      hasFlipped = true;
      cardNameEl.textContent = pendingCard.name;
      cardEnglishNameEl.textContent = pendingCard.englishName;
      cardDirectionEl.textContent = pendingCard.direction;
      cardMeaningEl.textContent = pendingCard.meaning;
      cardFrontImgEl.src = pendingCard.image;
      cardFrontImgEl.classList.toggle('is-reversed', Boolean(pendingCard.reversed));
      cardImgEnglishNameEl.textContent = pendingCard.englishName;
      cardBtnEl.classList.add('is-flipped');
      deepDailyBtnEl.disabled = false;
    }

    function smoothFocusPanel(panelEl) {
      const scrollToTarget = () => {
        if (!panelEl) return;
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight || 0;
        const panelRect = panelEl.getBoundingClientRect();
        const panelHeight = panelRect.height;

        // Long reading: align panel start to viewport top.
        if (panelHeight > viewportHeight) {
          const panelTop = window.scrollY + panelRect.top;
          window.scrollTo({
            top: Math.max(panelTop, 0),
            behavior: 'smooth'
          });
          return;
        }

        // Short reading: focus at page bottom.
        window.scrollTo({
          top: Math.max(document.documentElement.scrollHeight - viewportHeight, 0),
          behavior: 'smooth'
        });
      };
      requestAnimationFrame(() => {
        scrollToTarget();
        setTimeout(scrollToTarget, 260);
        setTimeout(scrollToTarget, 620);
      });
    }

    function startLoadingProgress(labelEl) {
      labelEl.innerHTML = '正在读取秘密脉络 <span class="loading-dots" aria-hidden="true"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';
      return {
        finish() {
          labelEl.textContent = '解读完成';
        },
        stop() {}
      };
    }

    async function fetchDailyReading(card) {
      const response = await fetch('/api/daily-reading', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          card: {
            name: card?.name,
            englishName: card?.englishName,
            direction: card?.direction,
            meaning: card?.meaning
          }
        })
      });

      if (!response.ok) {
        let reason = '';
        try {
          const errJson = await response.json();
          reason = errJson?.error || JSON.stringify(errJson);
        } catch (_) {
          reason = await response.text();
        }
        throw new Error(reason || 'API request failed');
      }

      const data = await response.json();
      if (!data?.text) {
        throw new Error('API returned empty text');
      }
      return data.text;
    }

    function buildDailyCacheKey(card) {
      return `${card?.englishName || ''}|${card?.direction || ''}|${card?.meaning || ''}`;
    }

    deepDailyBtnEl.addEventListener('click', async () => {
      if (!pendingCard || !hasFlipped) return;
      const willOpen = !deepDailyPanelEl.classList.contains('open');
      if (willOpen) {
        const cacheKey = buildDailyCacheKey(pendingCard);
        if (dailyReadingCacheKey === cacheKey && dailyReadingCacheText) {
          deepDailyPanelEl.classList.add('open');
          deepDailyBtnEl.classList.add('open');
          deepDailyTextEl.textContent = dailyReadingCacheText;
          smoothFocusPanel(deepDailyPanelEl);
          return;
        }
        deepDailyPanelEl.classList.add('open');
        deepDailyPanelEl.classList.add('is-loading');
        deepDailyBtnEl.classList.add('open');
        if (dailyProgressController) dailyProgressController.stop();
        dailyProgressController = startLoadingProgress(deepDailyLoadingLabelEl);
        smoothFocusPanel(deepDailyPanelEl);
        const requestId = ++dailyReadingRequestId;
        try {
          const gptText = await fetchDailyReading(pendingCard);
          if (requestId !== dailyReadingRequestId || !deepDailyPanelEl.classList.contains('open')) return;
          dailyProgressController?.finish();
          await new Promise((resolve) => setTimeout(resolve, 120));
          deepDailyPanelEl.classList.remove('is-loading');
          deepDailyTextEl.textContent = gptText;
          dailyReadingCacheKey = cacheKey;
          dailyReadingCacheText = gptText;
          smoothFocusPanel(deepDailyPanelEl);
        } catch (_) {
          if (requestId !== dailyReadingRequestId || !deepDailyPanelEl.classList.contains('open')) return;
          dailyProgressController?.finish();
          await new Promise((resolve) => setTimeout(resolve, 120));
          deepDailyPanelEl.classList.remove('is-loading');
          const fallbackText = buildDailyDeepReading(pendingCard);
          deepDailyTextEl.textContent = fallbackText;
          dailyReadingCacheKey = cacheKey;
          dailyReadingCacheText = fallbackText;
        }
        return;
      }
      dailyProgressController?.stop();
      deepDailyPanelEl.classList.remove('open');
      deepDailyPanelEl.classList.remove('is-loading');
      deepDailyBtnEl.classList.remove('open');
    });

    drawBtnEl.addEventListener('click', dealDailyCard);
    cardBtnEl.addEventListener('click', flipDailyCard);
  </script>
</body>
</html>
